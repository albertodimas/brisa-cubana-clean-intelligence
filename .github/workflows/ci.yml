name: CI (Main Branch)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Rama o tag a validar (por defecto main)"
        required: false
        default: "main"

jobs:
  lint:
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: Lint
      checkout-ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      run-secret-scan: true
      run-typecheck: false
      run-unit-tests: false
      run-build: false
      run-docs-verify: false
      run-e2e-suite: none
      run-database-prep: false

  typecheck:
    needs: lint
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: Typecheck
      checkout-ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      run-lint: false
      run-unit-tests: false
      run-build: false
      run-docs-verify: false
      run-e2e-suite: none
      run-database-prep: false

  unit-tests:
    needs:
      - lint
      - typecheck
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: Unit tests
      checkout-ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      run-lint: false
      run-typecheck: false
      run-build: false
      run-docs-verify: false
      run-e2e-suite: none
      run-database-prep: false

  build:
    needs:
      - lint
      - typecheck
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: Build
      checkout-ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      run-lint: false
      run-typecheck: false
      run-unit-tests: false
      run-docs-verify: false
      run-e2e-suite: none
      run-database-prep: false

  docs:
    needs:
      - lint
      - typecheck
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: Docs verify
      checkout-ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      run-lint: false
      run-typecheck: false
      run-unit-tests: false
      run-build: true
      run-e2e-suite: none
      run-database-prep: false

  e2e-critical:
    needs:
      - lint
      - typecheck
      - unit-tests
      - build
      - docs
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: E2E critical
      checkout-ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || '' }}
      run-lint: false
      run-typecheck: false
      run-unit-tests: false
      run-build: true
      run-docs-verify: false
      run-database-prep: true
      run-e2e-suite: critical
      next-public-api-url: "http://localhost:3001"
      playwright-report-name: playwright-report-critical
      playwright-retention-days: 7
      upload-playwright-only-on-failure: true

  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}
    needs:
      - lint
      - typecheck
      - unit-tests
      - build
      - docs
      - e2e-critical
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production-web
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.13.0'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Add pnpm to PATH
        run: |
          echo "$PNPM_HOME" >> "$GITHUB_PATH"

      - name: Refuerzo pnpm global
        run: |
          sudo npm install -g pnpm@10.18.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validar pnpm en PATH
        run: |
          pnpm --version
          command -v pnpm

      - name: Generate Prisma Client
        run: pnpm exec prisma generate
        working-directory: apps/api

      - name: Build applications (prebuild)
        run: pnpm turbo run build --filter=@brisa/api --filter=@brisa/web

      - name: Instalar Vercel CLI
        run: pnpm add --global vercel@48.6.0

      - name: Sincronizar configuraciÃ³n Vercel API
        working-directory: apps/api
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_API }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          export PATH="/usr/local/bin:$PNPM_HOME:$PATH"
          vercel pull --yes --environment=production --scope brisa-cubana --token "$VERCEL_TOKEN"

      - name: Deploy API to Vercel Production
        id: deploy-api
        working-directory: apps/api
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_API }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -euo pipefail
          export VERCEL_INSTALL_COMMAND="pnpm install --no-frozen-lockfile"
          DEPLOY_OUTPUT=$(vercel deploy --prod --yes --scope brisa-cubana --token "$VERCEL_TOKEN")
          echo "$DEPLOY_OUTPUT"
          API_URL=$(echo "$DEPLOY_OUTPUT" | sed -n 's/^.*Production:[[:space:]]*\([^[:space:]]\+\).*/\1/p' | tail -n1)
          if [ -z "$API_URL" ]; then
            API_URL=$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[A-Za-z0-9.-]+\.vercel\.app' | tail -n1)
          fi
          if [ -z "$API_URL" ]; then
            echo "No se pudo determinar la URL de producciÃ³n del API" >&2
            exit 1
          fi
          echo "url=$API_URL" >> "$GITHUB_OUTPUT"
          {
            echo "### ðŸš€ API Production Deployment"
            echo ""
            echo "- URL: $API_URL"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Sincronizar configuraciÃ³n Vercel Web
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          export PATH="/usr/local/bin:$PNPM_HOME:$PATH"
          vercel pull --yes --environment=production --scope brisa-cubana --token "$VERCEL_TOKEN"

      - name: Deploy Web to Vercel Production
        id: deploy-web
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -euo pipefail
          export VERCEL_INSTALL_COMMAND="pnpm install --no-frozen-lockfile"
          DEPLOY_OUTPUT=$(vercel deploy --prod --yes --scope brisa-cubana --token "$VERCEL_TOKEN")
          echo "$DEPLOY_OUTPUT"
          WEB_URL=$(echo "$DEPLOY_OUTPUT" | sed -n 's/^.*Production:[[:space:]]*\([^[:space:]]\+\).*/\1/p' | tail -n1)
          if [ -z "$WEB_URL" ]; then
            WEB_URL=$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[A-Za-z0-9.-]+\.vercel\.app' | tail -n1)
          fi
          if [ -z "$WEB_URL" ]; then
            echo "No se pudo determinar la URL de producciÃ³n del sitio web" >&2
            exit 1
          fi
          echo "url=$WEB_URL" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "### ðŸŒ Web Production Deployment"
            echo ""
            echo "- URL: $WEB_URL"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Smoke test production endpoints
        env:
          API_BASE_URL: ${{ steps.deploy-api.outputs.url }}
          WEB_BASE_URL: ${{ steps.deploy-web.outputs.url }}
          HEALTH_CHECK_TOKEN: ${{ secrets.HEALTH_CHECK_TOKEN }}
          API_ALIAS: https://api.brisacubanacleanintelligence.com
          WEB_ALIAS: https://brisacubanacleanintelligence.com
        run: |
          set -euo pipefail
          normalize_vercel_url() {
            local url="$1"
            local team_suffix="-brisa-cubana.vercel.app"
            if [[ "$url" =~ ^https://([^/]+)(/.*)?$ ]]; then
              local host="${BASH_REMATCH[1]}"
              local rest="${BASH_REMATCH[2]}"
              if [[ "$host" == *"$team_suffix" ]]; then
                local base="${host%$team_suffix}"
                base="${base%-*}"
                host="${base}.vercel.app"
              fi
              echo "https://${host}${rest}"
            else
              echo "$url"
            fi
          }
          API_CANONICAL_URL="$(normalize_vercel_url "$API_BASE_URL")"
          WEB_CANONICAL_URL="$(normalize_vercel_url "$WEB_BASE_URL")"
          if [[ -n "${API_ALIAS:-}" ]]; then
            API_CANONICAL_URL="${API_ALIAS%/}"
          fi
          if [[ -n "${WEB_ALIAS:-}" ]]; then
            WEB_CANONICAL_URL="${WEB_ALIAS%/}"
          fi
          echo "â„¹ï¸  API base resolved to $API_CANONICAL_URL"
          echo "â„¹ï¸  Web base resolved to $WEB_CANONICAL_URL"
          API_HEALTH_URL="${API_CANONICAL_URL%/}/healthz"
          WEB_HEALTH_URL="${WEB_CANONICAL_URL%/}/healthz"
          auth_args=()
          if [ -n "${HEALTH_CHECK_TOKEN:-}" ]; then
            auth_args=(--header "Authorization: Bearer ${HEALTH_CHECK_TOKEN}")
          fi
          echo "â„¹ï¸  Verificando $API_HEALTH_URL"
          if [ "${#auth_args[@]}" -gt 0 ]; then
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --retry 3 --retry-delay 2 "${auth_args[@]}" "$API_HEALTH_URL")
            WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --retry 3 --retry-delay 2 "${auth_args[@]}" "$WEB_HEALTH_URL")
          else
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --retry 3 --retry-delay 2 "$API_HEALTH_URL")
            WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --retry 3 --retry-delay 2 "$WEB_HEALTH_URL")
          fi
          if [ "$API_STATUS" -lt 200 ] || [ "$API_STATUS" -ge 300 ]; then
            echo "âŒ API health check failed with status $API_STATUS"
            exit 1
          fi
          echo "â„¹ï¸  Verificando $WEB_HEALTH_URL"
          if [ "$WEB_STATUS" -lt 200 ] || [ "$WEB_STATUS" -ge 300 ]; then
            echo "âŒ Web health check failed with status $WEB_STATUS"
            exit 1
          fi

      - name: Export Slack webhook secret
        id: slack-secret
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> "$GITHUB_ENV"
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install jq (for Slack payloads)
        if: ${{ steps.slack-secret.outputs.present == 'true' }}
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Post deploy Slack notification
        if: ${{ steps.slack-secret.outputs.present == 'true' }}
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
          WEB_URL: ${{ steps.deploy-web.outputs.url }}
          API_URL: ${{ steps.deploy-api.outputs.url }}
          COMMIT: ${{ github.sha }}
        run: |
          set -euo pipefail
          DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          PAYLOAD=$(jq -n --arg web "$WEB_URL" --arg api "$API_URL" --arg commit "$COMMIT" --arg time "$DEPLOY_TIME" '{
            text: "ðŸš€ *Deploy completado*",
            blocks: [
              {
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: "*Deploy completado*\nâ€¢ Web: <\($web)|\($web)>\nâ€¢ API: <\($api)|\($api)>\nâ€¢ Commit: `<\($commit)>`\nâ€¢ Momento (UTC): \($time)"
                }
              }
            ]
          }')
          if ! curl -fsS -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"; then
            echo "::warning::No se pudo entregar la notificaciÃ³n a Slack (respuesta no exitosa). Continuando sin bloquear el deploy."
          fi

      - name: Audit recent Vercel deployments
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          {
            echo ""
            echo "### ðŸ“Š Vercel deployment audit"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          LIMIT=5 scripts/report-vercel-deployments.sh >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          LIMIT=5 scripts/report-vercel-deployments.sh apps/api >> "$GITHUB_STEP_SUMMARY"
