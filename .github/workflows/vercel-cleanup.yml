name: Vercel Deployment Cleanup

on:
  schedule:
    - cron: "0 4 * * 1"  # Todos los lunes a las 04:00 UTC
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CLEANUP_ENABLED: ${{ vars.VERCEL_CLEANUP_ENABLED }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.13.0'

      - name: Validate secrets
        id: validate
        run: |
          set -euo pipefail
          if [ -z "${VERCEL_TOKEN:-}" ]; then
            echo "missing-token=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${VERCEL_ORG_ID:-}" ]; then
            echo "missing-org=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${VERCEL_PROJECT_WEB:-}" ] || [ -z "${VERCEL_PROJECT_API:-}" ]; then
            echo "missing-projects=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "missing-token=false" >> "$GITHUB_OUTPUT"
          echo "missing-org=false" >> "$GITHUB_OUTPUT"
          echo "missing-projects=false" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_WEB: ${{ secrets.VERCEL_PROJECT_WEB }}
          VERCEL_PROJECT_API: ${{ secrets.VERCEL_PROJECT_API }}

      - name: Report missing secrets
        if: steps.validate.outputs.missing-token == 'true' || steps.validate.outputs.missing-org == 'true' || steps.validate.outputs.missing-projects == 'true'
        run: |
          {
            echo "### ⚠️ Vercel cleanup omitido"
            if [ "${{ steps.validate.outputs.missing-token }}" = 'true' ]; then
              echo "- Falta configurar \`VERCEL_TOKEN\` en los secrets del repositorio."
            fi
            if [ "${{ steps.validate.outputs.missing-org }}" = 'true' ]; then
              echo "- Falta configurar \`VERCEL_ORG_ID\` en los secrets del repositorio."
            fi
            if [ "${{ steps.validate.outputs.missing-projects }}" = 'true' ]; then
              echo "- Falta configurar \`VERCEL_PROJECT_WEB\` y/o \`VERCEL_PROJECT_API\` en los secrets del repositorio."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Verify Vercel credential lengths
        if: steps.validate.outputs.missing-token == 'false' && steps.validate.outputs.missing-org == 'false' && steps.validate.outputs.missing-projects == 'false'
        run: |
          set -euo pipefail
          echo "VERCEL_ORG_ID length: ${#VERCEL_ORG_ID}"
          echo "VERCEL_PROJECT_WEB length: ${#VERCEL_PROJECT_WEB}"
          echo "VERCEL_PROJECT_API length: ${#VERCEL_PROJECT_API}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_WEB: ${{ secrets.VERCEL_PROJECT_WEB }}
          VERCEL_PROJECT_API: ${{ secrets.VERCEL_PROJECT_API }}

      - name: Clean web deployments (keep latest 3)
        if: steps.validate.outputs.missing-token == 'false' && steps.validate.outputs.missing-org == 'false' && steps.validate.outputs.missing-projects == 'false' && env.CLEANUP_ENABLED == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_WEB }}
        run: |
          set -euo pipefail
          node scripts/clean-vercel-deployments.mjs \
            --project brisa-cubana-clean-intelligence \
            --scope brisa-cubana \
            --token "$VERCEL_TOKEN" \
            --keep 3

      - name: Clean API deployments (keep latest 3)
        if: steps.validate.outputs.missing-token == 'false' && steps.validate.outputs.missing-org == 'false' && steps.validate.outputs.missing-projects == 'false' && env.CLEANUP_ENABLED == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_API }}
        run: |
          set -euo pipefail
          node scripts/clean-vercel-deployments.mjs \
            --project brisa-cubana-clean-intelligence-api \
            --scope brisa-cubana \
            --token "$VERCEL_TOKEN" \
            --keep 3

      - name: Publish summary
        if: steps.validate.outputs.missing-token == 'false' && steps.validate.outputs.missing-org == 'false' && steps.validate.outputs.missing-projects == 'false' && env.CLEANUP_ENABLED == 'true'
        run: |
          {
            echo "### 🧹 Vercel deployments cleanup"
            echo "- Web project: brisa-cubana-clean-intelligence (se conservan los 3 más recientes)"
            echo "- API project: brisa-cubana-clean-intelligence-api (se conservan los 3 más recientes)"
            echo "- Fecha de ejecución: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup deshabilitado
        if: steps.validate.outputs.missing-token == 'false' && steps.validate.outputs.missing-org == 'false' && steps.validate.outputs.missing-projects == 'false' && env.CLEANUP_ENABLED != 'true'
        run: |
          {
            echo "### ℹ️ Limpieza omitida"
            echo "El job fue deshabilitado vía \`VERCEL_CLEANUP_ENABLED\`. No se eliminaron deployments."
          } >> "$GITHUB_STEP_SUMMARY"
