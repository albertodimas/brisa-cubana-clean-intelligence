name: Vercel Deployment Cleanup

on:
  schedule:
    - cron: "0 4 * * 1"  # Todos los lunes a las 04:00 UTC
  workflow_dispatch:

jobs:
  cleanup:
    if: ${{ secrets.VERCEL_TOKEN != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.13.0'

      - name: Verify Vercel credentials
        run: |
          set -euo pipefail
          echo "VERCEL_ORG_ID length: ${#VERCEL_ORG_ID}"
          echo "VERCEL_PROJECT_WEB length: ${#VERCEL_PROJECT_WEB}"
          echo "VERCEL_PROJECT_API length: ${#VERCEL_PROJECT_API}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_WEB: ${{ secrets.VERCEL_PROJECT_WEB }}
          VERCEL_PROJECT_API: ${{ secrets.VERCEL_PROJECT_API }}

      - name: Clean web deployments (keep latest 3)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_WEB }}
        run: |
          set -euo pipefail
          node scripts/clean-vercel-deployments.mjs \
            --project brisa-cubana-clean-intelligence \
            --scope brisa-cubana \
            --token "$VERCEL_TOKEN" \
            --keep 3

      - name: Clean API deployments (keep latest 3)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_API }}
        run: |
          set -euo pipefail
          node scripts/clean-vercel-deployments.mjs \
            --project brisa-cubana-clean-intelligence-api \
            --scope brisa-cubana \
            --token "$VERCEL_TOKEN" \
            --keep 3

      - name: Publish summary
        run: |
          {
            echo "### 游빛 Vercel deployments cleanup"
            echo "- Web project: brisa-cubana-clean-intelligence (se conservan los 3 m치s recientes)"
            echo "- API project: brisa-cubana-clean-intelligence-api (se conservan los 3 m치s recientes)"
            echo "- Fecha de ejecuci칩n: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          } >> "$GITHUB_STEP_SUMMARY"

  missing-token:
    if: ${{ secrets.VERCEL_TOKEN == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Report missing token
        run: |
          {
            echo "### 丘멆잺 Vercel cleanup omitido"
            echo "No se proporcion칩 \`VERCEL_TOKEN\` en los secrets del repositorio, por lo que no se ejecut칩 la limpieza autom치tica."
          } >> "$GITHUB_STEP_SUMMARY"
