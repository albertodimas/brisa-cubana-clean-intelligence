name: Nightly Full E2E Suite

on:
  schedule:
    # Runs at 2:00 AM UTC every day
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual triggers

jobs:
  full-e2e:
    uses: ./.github/workflows/project-pipeline.yml
    secrets: inherit
    with:
      environment-name: preview-web
      job-name: Nightly full e2e
      run-database-prep: true
      run-e2e-suite: full
      disable-posthog: true
      playwright-report-name: playwright-report-full
      playwright-retention-days: 14
      run-lighthouse: false
      enable-test-utils: false

  lighthouse:
    name: Nightly Lighthouse budgets
    runs-on: ubuntu-latest
    needs: full-e2e
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup project
        uses: ./.github/actions/setup-project
        with:
          node-version: 22.13.0
          pnpm-version: 10.18.0
          install-playwright: false
          run-prisma-generate: false

      - name: Run Lighthouse CI against Vercel production
        id: lhci
        continue-on-error: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: pnpm exec lhci autorun --config=.lighthouserc.preview.json

      - name: Evaluate Lighthouse failure streak
        if: steps.lhci.outcome == 'failure'
        id: evaluate-streak
        env:
          GITHUB_TOKEN: ${{ github.token }}
          LIGHTHOUSE_WORKFLOW_FILE: nightly.yml
          LIGHTHOUSE_JOB_NAME: Nightly Lighthouse budgets
        run: |
          STREAK=$(python3 scripts/check_lighthouse_streak.py)
          echo "streak=$STREAK" >> "$GITHUB_OUTPUT"
          {
            echo "### Lighthouse budgets failing"
            echo
            echo "- Consecutive failures: $STREAK"
            echo "- Workflow: nightly.yml"
          } >> "$GITHUB_STEP_SUMMARY"
          if [ "$STREAK" -ge 3 ]; then
            echo "Lighthouse budgets have failed $STREAK consecutive runs" >&2
            exit 1
          fi

      - name: Mark Lighthouse job failure
        if: steps.lhci.outcome == 'failure'
        run: exit 1
