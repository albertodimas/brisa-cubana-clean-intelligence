name: Nightly Full E2E Suite

on:
  schedule:
    # Runs at 2:00 AM UTC every day
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual triggers

jobs:
  full-e2e:
    uses: ./.github/workflows/project-pipeline.yml
    with:
      job-name: Nightly full e2e
      run-database-prep: true
      run-e2e-suite: full
      playwright-report-name: playwright-report-full
      playwright-retention-days: 14
      run-lighthouse: false
      enable-test-utils: false
    secrets:
      api-token: ${{ secrets.API_TOKEN }}
      jwt-secret: ${{ secrets.JWT_SECRET }}
      auth-secret: ${{ secrets.AUTH_SECRET }}
      portal-magic-link-from: ${{ secrets.PORTAL_MAGIC_LINK_FROM }}
      portal-magic-link-smtp-host: ${{ secrets.PORTAL_MAGIC_LINK_SMTP_HOST }}
      portal-magic-link-smtp-port: ${{ secrets.PORTAL_MAGIC_LINK_SMTP_PORT }}
      portal-magic-link-smtp-user: ${{ secrets.PORTAL_MAGIC_LINK_SMTP_USER }}
      portal-magic-link-smtp-password: ${{ secrets.PORTAL_MAGIC_LINK_SMTP_PASSWORD }}
      portal-magic-link-smtp-secure: ${{ secrets.PORTAL_MAGIC_LINK_SMTP_SECURE }}
      log_drain_verification_code: ${{ secrets.LOG_DRAIN_VERIFICATION_CODE }}
      e2e_admin_email: ${{ secrets.E2E_ADMIN_EMAIL }}
      e2e_admin_password: ${{ secrets.E2E_ADMIN_PASSWORD }}
      e2e_coordinator_email: ${{ secrets.E2E_COORDINATOR_EMAIL }}
      e2e_coordinator_password: ${{ secrets.E2E_COORDINATOR_PASSWORD }}

  lighthouse:
    name: Nightly Lighthouse budgets
    runs-on: ubuntu-latest
    needs: full-e2e
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js 22.13
        uses: actions/setup-node@v4
        with:
          node-version: 22.13.0

      - name: Install dependencies
        run: |
          npm install -g pnpm@10.18.0
          pnpm install --frozen-lockfile

      - name: Run Lighthouse CI against Vercel production
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: pnpm exec lhci autorun --config=.lighthouserc.preview.json
