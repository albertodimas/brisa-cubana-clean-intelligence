---
# Istio VirtualService for API traffic management
# Provides advanced routing, retries, and circuit breaking

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-virtual-service
  namespace: brisa-production
spec:
  hosts:
    - api.brisacubana.com
    - api.brisa-production.svc.cluster.local
  gateways:
    - brisa-gateway
  http:
    # Canary traffic split (90/10)
    - match:
        - headers:
            canary:
              exact: "true"
      route:
        - destination:
            host: api-service
            subset: canary
          weight: 100

    # Production traffic with weighted routing
    - route:
        - destination:
            host: api-service
            subset: stable
          weight: 90
        - destination:
            host: api-service
            subset: canary
          weight: 10

      # Retry policy
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: 5xx,reset,connect-failure,refused-stream

      # Timeout
      timeout: 30s

      # Circuit breaker via fault injection
      fault:
        abort:
          percentage:
            value: 0.1  # 0.1% fault injection for testing
          httpStatus: 503
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: web-virtual-service
  namespace: brisa-production
spec:
  hosts:
    - brisacubana.com
    - www.brisacubana.com
  gateways:
    - brisa-gateway
  http:
    - match:
        - uri:
            prefix: /api
      rewrite:
        uri: /
      route:
        - destination:
            host: api-service
            port:
              number: 3001

    - route:
        - destination:
            host: web-service
            port:
              number: 3000

      timeout: 60s
      retries:
        attempts: 2
        perTryTimeout: 5s
