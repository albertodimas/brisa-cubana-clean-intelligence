generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

enum UserRole {
  ADMIN
  COORDINATOR
  STAFF
  CLIENT
}

enum PropertyType {
  RESIDENTIAL
  VACATION_RENTAL
  OFFICE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_CANCELLED
  BOOKING_RESCHEDULED
  BOOKING_REMINDER_24H
  BOOKING_REMINDER_1H
  BOOKING_COMPLETED
  BOOKING_STATUS_CHANGED
  USER_DEACTIVATED
  SERVICE_UPDATED
}

enum NotificationChannel {
  EMAIL
  SMS
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  fullName     String
  role         UserRole  @default(CLIENT)
  isActive     Boolean   @default(true)
  passwordHash String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  properties    Property[]
  bookings      Booking[]      @relation("BookingCustomer")
  notifications Notification[]
  assignedBookings Booking[] @relation("BookingAssignedStaff")
  userSessions UserSession[]

  @@index([deletedAt])
}

model Property {
  id          String       @id @default(cuid())
  label       String       @unique
  addressLine String
  city        String
  state       String       @default("FL")
  zipCode     String
  type        PropertyType
  notes       String?
  sqft        Int?
  bedrooms    Int?
  bathrooms   Int?
  ownerId     String
  owner       User         @relation(fields: [ownerId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  bookings Booking[]

  @@index([deletedAt])
}

model Service {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  basePrice   Decimal   @db.Decimal(10, 2)
  durationMin Int
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  bookings Booking[]

  @@index([deletedAt])
}

model Booking {
  id          String        @id @default(cuid())
  code        String        @unique
  scheduledAt DateTime
  durationMin Int
  notes       String?
  status      BookingStatus @default(PENDING)
  totalAmount Decimal       @db.Decimal(10, 2)
  customerId  String
  customer    User          @relation("BookingCustomer", fields: [customerId], references: [id])
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id])
  serviceId   String
  service     Service       @relation(fields: [serviceId], references: [id])
  assignedStaffId String?
  assignedStaff   User?         @relation("BookingAssignedStaff", fields: [assignedStaffId], references: [id])
  invoices    Invoice[]
  notifications Notification[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  @@index([deletedAt])
  @@index([assignedStaffId])
}

model Notification {
  id        String              @id @default(cuid())
  userId    String
  user      User                @relation(fields: [userId], references: [id])
  type      NotificationType
  channel   NotificationChannel @default(IN_APP)
  status    NotificationStatus  @default(PENDING)
  subject   String?
  message   String
  metadata  Json?
  sentAt    DateTime?
  failedAt  DateTime?
  errorMessage String?
  readAt    DateTime?
  bookingId String?
  booking   Booking?            @relation(fields: [bookingId], references: [id])
  createdAt DateTime            @default(now())

  @@index([userId, readAt])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([bookingId])
}

model MagicLinkToken {
  id         String    @id @default(cuid())
  email      String
  tokenHash  String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([email, expiresAt])
  @@index([consumedAt])
}

model UserSession {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  tokenHash        String   @unique
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  revokedAt        DateTime?
  revocationReason String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId, revokedAt])
  @@index([expiresAt])
}

model PortalSession {
  id               String   @id @default(cuid())
  email            String
  tokenHash        String   @unique
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  revokedAt        DateTime?
  revocationReason String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email, revokedAt])
  @@index([expiresAt])
}

model Lead {
  id              String     @id @default(cuid())
  name            String
  email           String
  phone           String?
  company         String?
  propertyCount   String?
  serviceInterest String?
  planCode        String?
  notes           String?
  status          LeadStatus @default(NEW)
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmContent      String?
  utmTerm         String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

model StripeWebhookEvent {
  id            String    @id @default(cuid())
  stripeEventId String    @unique
  eventType     String
  processed     Boolean   @default(false)
  processedAt   DateTime?
  metadata      Json?
  errorMessage  String?
  createdAt     DateTime  @default(now())

  @@index([stripeEventId])
  @@index([eventType, processed])
  @@index([createdAt])
}

model Invoice {
  id                   String        @id @default(cuid())
  bookingId            String
  booking              Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  stripePaymentIntentId String?      @unique
  amount               Decimal       @db.Decimal(10, 2)
  status               InvoiceStatus @default(PENDING)
  paidAt               DateTime?
  metadata             Json?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@index([bookingId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum TestimonialStatus {
  PENDING
  APPROVED
  REJECTED
}

model Testimonial {
  id        String            @id @default(cuid())
  author    String
  role      String
  quote     String            @db.Text
  status    TestimonialStatus @default(PENDING)
  order     Int               @default(0)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([status, isActive, order])
}

model FAQ {
  id        String   @id @default(cuid())
  question  String   @db.Text
  answer    String   @db.Text
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, order])
}

model PricingTier {
  id           String   @id @default(cuid())
  tierCode     String   @unique
  name         String
  headline     String
  description  String?  @db.Text
  price        String
  priceSuffix  String?
  features     Json
  addons       Json?
  highlighted  Boolean  @default(false)
  isActive     Boolean  @default(true)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, order])
}

model PortfolioStats {
  id              String   @id @default(cuid())
  activeProperties Int
  averageRating   Decimal  @db.Decimal(3, 2)
  totalTurnovers  Int
  period          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([createdAt(sort: Desc)])
}

model MarketStat {
  id           String   @id @default(cuid())
  metricId     String   @unique
  label        String
  value        Decimal  @db.Decimal(10, 2)
  valueMax     Decimal? @db.Decimal(10, 2)
  source       String
  sourceUrl    String?
  period       String?
  notes        String?  @db.Text
  presentation Json
  lastUpdated  DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([metricId])
}

model PortalSession {
  id               String   @id @default(cuid())
  email            String
  tokenHash        String   @unique
  userAgent        String?
  ipAddress        String?
  expiresAt        DateTime
  revokedAt        DateTime?
  revocationReason String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email, revokedAt])
  @@index([expiresAt])
}
